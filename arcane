#! /usr/bin/env python
"""Arcane 

This encryption tool connects to a specified IMAP4 compatible mail
server, authenticates with a given username/password and encrypts all
unencrypted mail in the users mailbox.

The Encryption should be possible with X.509 Certificates and Public PGP
Keys (using a gpg library). There is also an option to reencrypt already
encrypted E-Mails with a different public key (for a nice key-rollover
procedure).

Last but not least a daemon function, where incoming mail is encrypted
would also be nice.
"""
import sys
import getopt
import getpass
import imap

DEFAULT_SSL_PORT = 993
DEFAULT_PORT = 143

def main(argv=None):
	if argv==None:
		argv = sys.argv

	# Initial Arguments
	port = 0
	hostname = ""
	username = ""
	key = ""
	ssl = False

	# parse arguments
	try:
		optlist, args = getopt.getopt(sys.argv[1:],"h:p:su:k:",["hostname=", "port=","ssl","username=","key="])
	except getopt.GetoptError as err:
		usage()
		return 2


	for o, a in optlist:
		if o in ("-h","--hostname"):
			hostname = a
		elif o in ("-p","--port"): 
			port = int(a)
		elif o in ("-s","--ssl"):
			ssl = True
		elif o in ("-u","--username"):
			username = a
		elif o in ("-k","--key"):
			key = a
		else:
			usage()
			return 1

	if port == 0:
		if ssl == True:
			port = DEFAULT_SSL_PORT
		else:
			port = DEFAULT_PORT

	if hostname == "":
		print >> sys.stderr,"Connection not possible without hostname\n"
		usage()
		return 1

	if username == "":
		print >> sys.stderr,"Authentication not possible without username\n"
		usage()
		return 1

	if key == "":
		print >> sys.stderr,"Encryption not possible without key identifier\n"
		usage()
		return 1
		
	# open connection
	conn = imap.IMAPConnection(hostname,port,ssl,username,getpass.getpass())

	# Encrypt all mails
	for mailbox in conn:
		print mailbox
		for mail in mailbox:
			if not mail.isEncrypted():
				mail.encryptPGP(key)
				mail.store()
				sys.stdout.write('.')
			else:
				sys.stdout.write('X')
			sys.stdout.flush()

def usage():
	print >> sys.stderr, "Usage: arcane -h hostname [-p port] [-s] -u username"
	print >> sys.stderr, "\t-h,--hostname\tHostname of IMAP4 compatible mailserver"
	print >> sys.stderr, "\t-p,--port\tOptional port number of IMAP4 service"
	print >> sys.stderr, "\t-s,--ssl\tOptional SSL flag (changes default port to 993)"
	print >> sys.stderr, "\t-u,--username\tUsername that should be used for authentication"
	print >> sys.stderr, "\t-k,--key\tPublic key Identifier that will be used to encrypt the mails"
	

if __name__  == "__main__":
	sys.exit(main())
